<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quáº£n LÃ½ Há»c Sinh 11A4 - Firebase Connected</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 1250px; margin: 0 auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        .header-section { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #007bff; padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; color: #2c3e50; font-size: 24px; }
        
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; display: inline-block; }
        .role-super { background: #6610f2; color: #fff; }
        .role-admin { background: #d1e7dd; color: #0f5132; }
        .role-user { background: #cfe2ff; color: #084298; }
        .role-guest { background: #f8d7da; color: #842029; }

        .stats-bar { display: flex; gap: 15px; background: #e7f1ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #004085; font-weight: 600; flex-wrap: wrap; }
        .stats-item span { color: #dc3545; font-size: 1.2em; margin-left: 5px; }

        .panel { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .admin-title { font-weight: bold; margin-bottom: 15px; color: #856404; text-transform: uppercase; border-bottom: 1px solid #ffeeba; padding-bottom: 5px; font-size: 14px; }
        
        .form-group { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        input, select, textarea { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; outline: none; }
        
        button { cursor: pointer; padding: 10px 15px; border: none; border-radius: 6px; color: white; font-weight: 600; transition: 0.2s; font-size: 14px; }
        .btn-add { background-color: #198754; grid-column: 1 / -1; }
        .btn-edit { background-color: #ffc107; color: #000; font-size: 12px; padding: 5px 8px; }
        .btn-delete { background-color: #dc3545; font-size: 12px; padding: 5px 8px; }
        .btn-excel { background-color: #198754; }

        .log-section { background: white; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .log-body { max-height: 250px; overflow-y: auto; padding: 10px; font-size: 12px; }

        .table-responsive { overflow-x: auto; border-radius: 8px; box-shadow: 0 0 0 1px #dee2e6; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background-color: #007bff; color: white; text-transform: uppercase; font-size: 12px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 500px; max-width: 95%; position: relative; box-sizing: border-box; }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 28px; cursor: pointer; color: #aaa; }
        
        .search-input { width: 300px; padding: 10px; border: 2px solid #007bff; border-radius: 6px; }
        .badge-doan { background: #ff4757; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h1>ğŸ“ Quáº£n LÃ½ Lá»›p 11A4 (Online)</h1>
        <div class="admin-controls">
            <span id="userStatus" class="status-badge role-guest">KhÃ¡ch</span>
            <button id="btnAuth" style="background:#0d6efd" onclick="window.moFormDangNhap()">ğŸ”‘ ÄÄƒng nháº­p</button>
            <button id="btnLogout" style="background:#6c757d; display:none" onclick="window.dangXuat()">ğŸšª ÄÄƒng xuáº¥t</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stats-item">Tá»•ng sÄ© sá»‘: <span id="tongSiSo">0</span></div>
        <div class="stats-item">Nam: <span id="tongNam">0</span> ğŸ‘¦</div>
        <div class="stats-item">Ná»¯: <span id="tongNu">0</span> ğŸ‘§</div>
        <div class="stats-item">ÄoÃ n viÃªn: <span id="tongDoanVien">0</span> ğŸ‡»ğŸ‡³</div>
    </div>

    <div id="superAdminPanel" class="panel">
        <div class="admin-title">ğŸ›¡ï¸ Quáº£n lÃ½ há»‡ thá»‘ng</div>
        <p>TÃ­nh nÄƒng quáº£n lÃ½ tÃ i khoáº£n Ä‘ang Ä‘Æ°á»£c báº£o trÃ¬ Ä‘á»ƒ Æ°u tiÃªn tÃ­nh nÄƒng há»c sinh.</p>
    </div>

    <div id="adminArea" class="panel">
        <div class="admin-title">ğŸ› ï¸ ThÃªm há»c sinh má»›i</div>
        <div class="form-group">
            <input type="text" id="hoTen" placeholder="Há» vÃ  TÃªn (Báº¯t buá»™c)">
            <select id="gioiTinh"><option value="Nam">Nam</option><option value="Ná»¯">Ná»¯</option></select>
            <select id="isDoanVien"><option value="ChÆ°a">ChÆ°a vÃ o ÄoÃ n</option><option value="ÄoÃ n viÃªn">ÄoÃ n viÃªn</option></select>
            <input type="text" id="danToc" placeholder="DÃ¢n tá»™c">
            <input type="text" id="ngaySinh" placeholder="NgÃ y sinh (dd/mm/yyyy)">
            <input type="text" id="sdt" placeholder="SÄT">
            <input type="text" id="email" placeholder="Email">
            <input type="text" id="queQuan" placeholder="QuÃª quÃ¡n">
            <input type="text" id="diaChi" placeholder="Äá»‹a chá»‰" style="grid-column: span 2;">
            <button class="btn-add" onclick="window.themHocSinh()">â• ThÃªm Há»c Sinh</button>
        </div>
        <button class="btn-excel" onclick="window.xuatHocSinhExcel()">ğŸ“¥ Xuáº¥t Excel (CSV)</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" onkeyup="window.timKiemHocSinh()" placeholder="ğŸ” TÃ¬m tÃªn há»c sinh...">
    </div>

    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>STT</th><th>Há» TÃªn</th><th>Giá»›i TÃ­nh</th><th>ÄoÃ n ViÃªn</th><th>DÃ¢n Tá»™c</th><th>NgÃ y Sinh</th><th>SÄT</th><th>QuÃª QuÃ¡n</th><th>Äá»‹a Chá»‰</th><th>HÃ nh Äá»™ng</th>
                </tr>
            </thead>
            <tbody id="thanBang">
                <tr><td colspan="10" style="text-align:center">Äang káº¿t ná»‘i Ä‘áº¿n mÃ¡y chá»§ Firebase...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="window.dongFormSua()">&times;</span>
        <h3>Sá»­a ThÃ´ng Tin</h3>
        <input type="hidden" id="editId">
        <input type="text" id="editHoTen" placeholder="Há» tÃªn" style="margin-bottom:10px">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px">
            <select id="editGioiTinh"><option value="Nam">Nam</option><option value="Ná»¯">Ná»¯</option></select>
            <select id="editDoanVien"><option value="ChÆ°a">ChÆ°a vÃ o ÄoÃ n</option><option value="ÄoÃ n viÃªn">ÄoÃ n viÃªn</option></select>
        </div>
        <input type="text" id="editNgaySinh" placeholder="NgÃ y sinh" style="margin-bottom:10px">
        <input type="text" id="editSdt" placeholder="SÄT" style="margin-bottom:10px">
        <input type="text" id="editQueQuan" placeholder="QuÃª quÃ¡n" style="margin-bottom:10px">
        <input type="text" id="editDiaChi" placeholder="Äá»‹a chá»‰" style="margin-bottom:10px">
        <button style="background:#ffc107; color:#000; width:100%" onclick="window.luuCapNhatHS()">LÆ¯U THAY Äá»”I</button>
    </div>
</div>

<div id="loginModal" class="modal">
    <div class="modal-content" style="width:300px">
        <span class="close-btn" onclick="window.dongFormDangNhap()">&times;</span>
        <h3>ÄÄƒng nháº­p Admin</h3>
        <input type="text" id="loginUser" placeholder="TÃªn Ä‘Äƒng nháº­p" style="margin-bottom:10px">
        <input type="password" id="loginPass" placeholder="Máº­t kháº©u" style="margin-bottom:10px">
        <button style="background:#007bff; width:100%" onclick="window.xuLyDangNhap()">ÄÄ‚NG NHáº¬P</button>
    </div>
</div>

<script type="module">
    // 1. IMPORT FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // 2. Cáº¤U HÃŒNH FIREBASE (Dá»± Ã¡n list11a4-881e5)
    const firebaseConfig = {
        apiKey: "AIzaSyDLkLYuOMgohtOrY6bgCGMVgXtX1gxyhjU",
        authDomain: "list11a4-881e5.firebaseapp.com",
        projectId: "list11a4-881e5",
        storageBucket: "list11a4-881e5.firebasestorage.app",
        messagingSenderId: "38420140568",
        appId: "1:38420140568:web:9d73883049845f0cd3296d",
        measurementId: "G-W1RV28264K"
    };

    // Khá»Ÿi táº¡o
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COLLECTION_NAME = "hocsinh_11a4"; // TÃªn báº£ng dá»¯ liá»‡u

    // Biáº¿n toÃ n cá»¥c
    let currentRole = localStorage.getItem('user_role') || 'guest';
    let currentUser = localStorage.getItem('user_name') || 'KhÃ¡ch';
    let danhSachHocSinh = [];

    // --- LOGIC REALTIME (Láº¯ng nghe dá»¯ liá»‡u) ---
    onSnapshot(collection(db, COLLECTION_NAME), (snapshot) => {
        danhSachHocSinh = [];
        snapshot.forEach((doc) => {
            let data = doc.data();
            data.id = doc.id; // Láº¥y ID cá»§a document
            danhSachHocSinh.push(data);
        });
        
        // Sáº¯p xáº¿p theo tÃªn (tÃ¹y chá»n)
        danhSachHocSinh.sort((a, b) => a.hoTen.localeCompare(b.hoTen));
        
        window.hienThiHocSinh();
    }, (error) => {
        console.error("Lá»—i káº¿t ná»‘i:", error);
        document.getElementById("thanBang").innerHTML = `<tr><td colspan="10" style="color:red; text-align:center">Lá»—i káº¿t ná»‘i! Vui lÃ²ng kiá»ƒm tra Firestore Rules (Native Mode).<br>${error.message}</td></tr>`;
    });

    // --- CÃC HÃ€M Xá»¬ LÃ (GÃ¡n vÃ o window) ---

    // 1. Hiá»ƒn thá»‹ báº£ng
    window.hienThiHocSinh = function(data = danhSachHocSinh) {
        let tbody = document.getElementById("thanBang");
        let html = '';
        // Quyá»n sá»­a/xÃ³a: Chá»‰ Admin hoáº·c Super Admin
        let canEdit = (currentRole === 'super_admin' || currentRole === 'admin');
        
        // Update thá»‘ng kÃª
        document.getElementById("tongSiSo").innerText = data.length;
        document.getElementById("tongNam").innerText = data.filter(h=>h.gioiTinh==='Nam').length;
        document.getElementById("tongNu").innerText = data.filter(h=>h.gioiTinh==='Ná»¯').length;
        document.getElementById("tongDoanVien").innerText = data.filter(h=>h.doanVien==='ÄoÃ n viÃªn').length;

        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center">ChÆ°a cÃ³ dá»¯ liá»‡u há»c sinh.</td></tr>';
            return;
        }

        data.forEach((hs, i) => {
            let isDoan = hs.doanVien === 'ÄoÃ n viÃªn' ? '<span class="badge-doan">ğŸ‡»ğŸ‡³ ÄoÃ n viÃªn</span>' : 'ChÆ°a';
            html += `<tr>
                <td>${i+1}</td>
                <td><b>${hs.hoTen}</b></td>
                <td>${hs.gioiTinh}</td>
                <td>${isDoan}</td>
                <td>${hs.danToc || ''}</td>
                <td>${hs.ngaySinh || ''}</td>
                <td>${hs.sdt || ''}</td>
                <td>${hs.queQuan || ''}</td>
                <td>${hs.diaChi || ''}</td>
                <td>${canEdit ? 
                    `<button class="btn-edit" onclick="window.chuanBiSua('${hs.id}')">Sá»­a</button> 
                     <button class="btn-delete" onclick="window.xoaHocSinh('${hs.id}')">XÃ³a</button>` 
                    : '<span style="color:#ccc">---</span>'}</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // 2. ThÃªm má»›i
    window.themHocSinh = async function() {
        let t = document.getElementById("hoTen").value.trim();
        if(!t) return alert("Vui lÃ²ng nháº­p há» tÃªn há»c sinh!");
        
        const hsMoi = {
            hoTen: t,
            gioiTinh: document.getElementById("gioiTinh").value,
            doanVien: document.getElementById("isDoanVien").value,
            danToc: document.getElementById("danToc").value,
            ngaySinh: document.getElementById("ngaySinh").value,
            sdt: document.getElementById("sdt").value,
            queQuan: document.getElementById("queQuan").value,
            diaChi: document.getElementById("diaChi").value,
            ngayTao: new Date().toISOString()
        };

        try {
            await addDoc(collection(db, COLLECTION_NAME), hsMoi);
            alert("âœ… ÄÃ£ thÃªm há»c sinh thÃ nh cÃ´ng!");
            // Clear form
            document.querySelectorAll('#adminArea input').forEach(input => input.value = '');
        } catch (e) {
            alert("Lá»—i khi thÃªm: " + e.message);
        }
    }

    // 3. XÃ³a
    window.xoaHocSinh = async function(id) {
        if(confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a há»c sinh nÃ y khÃ´ng? HÃ nh Ä‘á»™ng nÃ y khÃ´ng thá»ƒ hoÃ n tÃ¡c.")) {
            try {
                await deleteDoc(doc(db, COLLECTION_NAME, id));
            } catch (e) {
                alert("Lá»—i xÃ³a: " + e.message);
            }
        }
    }

    // 4. Sá»­a (Load Form)
    window.chuanBiSua = function(id) {
        let hs = danhSachHocSinh.find(h => h.id === id);
        if(!hs) return;
        
        document.getElementById("editId").value = hs.id;
        document.getElementById("editHoTen").value = hs.hoTen;
        document.getElementById("editGioiTinh").value = hs.gioiTinh;
        document.getElementById("editDoanVien").value = hs.doanVien;
        document.getElementById("editNgaySinh").value = hs.ngaySinh;
        document.getElementById("editSdt").value = hs.sdt;
        document.getElementById("editQueQuan").value = hs.queQuan;
        document.getElementById("editDiaChi").value = hs.diaChi;
        document.getElementById("editModal").style.display = "flex";
    }

    // 5. LÆ°u Sá»­a (Update)
    window.luuCapNhatHS = async function() {
        let id = document.getElementById("editId").value;
        const dataMoi = {
            hoTen: document.getElementById("editHoTen").value,
            gioiTinh: document.getElementById("editGioiTinh").value,
            doanVien: document.getElementById("editDoanVien").value,
            ngaySinh: document.getElementById("editNgaySinh").value,
            sdt: document.getElementById("editSdt").value,
            queQuan: document.getElementById("editQueQuan").value,
            diaChi: document.getElementById("editDiaChi").value
        };

        try {
            await updateDoc(doc(db, COLLECTION_NAME, id), dataMoi);
            alert("âœ… Cáº­p nháº­t thÃ nh cÃ´ng!");
            window.dongFormSua();
        } catch (e) {
            alert("Lá»—i cáº­p nháº­t: " + e.message);
        }
    }

    // 6. ÄÄƒng nháº­p / ÄÄƒng xuáº¥t
    window.xuLyDangNhap = function() {
        let u = document.getElementById("loginUser").value;
        let p = document.getElementById("loginPass").value;

        // TÃ i khoáº£n cá»©ng (Hardcode)
        if(u === 'trannhuthang' && p === '26032009') {
            currentRole = 'super_admin';
            currentUser = 'Admin Tháº¯ng';
            saveAuth();
            window.capNhatGiaoDien();
            window.hienThiHocSinh(); // Render láº¡i Ä‘á»ƒ hiá»‡n nÃºt
            window.dongFormDangNhap();
            alert("Xin chÃ o Admin!");
        } else {
            alert("Sai tÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u!");
        }
    }

    window.dangXuat = function() {
        if(confirm("ÄÄƒng xuáº¥t?")) {
            currentRole = 'guest';
            currentUser = 'KhÃ¡ch';
            saveAuth();
            window.location.reload(); // Táº£i láº¡i trang cho sáº¡ch
        }
    }

    function saveAuth() {
        localStorage.setItem('user_role', currentRole);
        localStorage.setItem('user_name', currentUser);
    }

    // 7. Giao diá»‡n & Tiá»‡n Ã­ch
    window.capNhatGiaoDien = function() {
        document.getElementById("userStatus").innerText = currentUser;
        
        if(currentRole === 'super_admin' || currentRole === 'admin') {
            document.getElementById("userStatus").className = "status-badge role-super";
            document.getElementById("adminArea").style.display = "block";
            document.getElementById("btnAuth").style.display = "none";
            document.getElementById("btnLogout").style.display = "inline-block";
        } else {
            document.getElementById("userStatus").className = "status-badge role-guest";
            document.getElementById("adminArea").style.display = "none";
            document.getElementById("btnAuth").style.display = "inline-block";
            document.getElementById("btnLogout").style.display = "none";
        }
    }

    window.timKiemHocSinh = function() {
        let key = document.getElementById("searchInput").value.toLowerCase();
        let filtered = danhSachHocSinh.filter(h => h.hoTen.toLowerCase().includes(key));
        window.hienThiHocSinh(filtered);
    }
    
    window.xuatHocSinhExcel = function() {
        let csv = "\ufeffSTT,Há» TÃªn,Giá»›i TÃ­nh,ÄoÃ n ViÃªn,NgÃ y Sinh,SÄT,QuÃª QuÃ¡n\n";
        danhSachHocSinh.forEach((hs, i) => {
            csv += `${i + 1},${hs.hoTen},${hs.gioiTinh},${hs.doanVien},${hs.ngaySinh},${hs.sdt},${hs.queQuan}\n`;
        });
        let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Danh_Sach_11A4.csv";
        link.click();
    }

    window.moFormDangNhap = () => document.getElementById("loginModal").style.display = "flex";
    window.dongFormDangNhap = () => document.getElementById("loginModal").style.display = "none";
    window.dongFormSua = () => document.getElementById("editModal").style.display = "none";

    // Khá»Ÿi cháº¡y
    window.capNhatGiaoDien();
</script>
</body>
</html>